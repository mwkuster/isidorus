<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>isidorus with protype and scriptaclous</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!-- <meta http-equiv="pragma" content="no-cache"/> --> <!-- this statement is necessary to avoid browser caching, but does not work with IE --> 
    <link rel="stylesheet" type="text/css" href="main.css"/>

    <!-- includes the jQuery framework -->
    <script language="JavaScript" type="text/javascript" src="javascripts/jquery-1.3.2.js"></script>


    <!-- own javascript code -->
    <script language="JavaScript" type="text/javascript"><!-- // for browsers that don't support javascript
     // --- some constants -----------------------------------------------------
     var HOST_PREF = "http://localhost:8000/";
     var GET_PREFIX = HOST_PREF + "json/get/";
     var COMMIT_URL = HOST_PREF + "json/commit/";
     var ALL_PSIS_URL = HOST_PREF + "json/psis/";
     var OWN_URL = HOST_PREF + "isidorus";

     // --- navigates the user to the initial page with empty values
     function goBack()
     {
	 window.location = OWN_URL;
     }


     // --- the general error handler for all ajax requests
     function errorHandler(xhr)
     {
	 alert("something went wrong ... " + xhr.status + ": " + xhr.statusText);
     }


     // --- gets a list of lists of psis and produces an unordered list of them with a click event
     // --- so the user is able to select a single psi which is neede to get a fragment
     function getAllPsis()
     {
	 function successHandler(data)
	 {
	     // --- removes all elements not neede in this action
	     $("#allPsisList").remove();
	     $("#commitButton").remove();

	     // --- the json actions
	     var json = eval(data);

	     $("#allPsisButton").after('<ul id="allPsisList"<ul></ul>');
	     $.each(json, function(idx, topicPsis)
		    {
			var htmlStr = "";
			$.each(topicPsis, function(innerIdx, psi)
			       {
				   if(innerIdx != 0){
				       htmlStr += "<br/>";
				   }				   
				   htmlStr += '<span id="' + idx + '_' + innerIdx + '">' + psi + "</span>";
			       });


			$("#allPsisList").html($("#allPsisList").html() + "<li>" + htmlStr + "</li>");
			
		    });


	     // --- some effects
	     $("li").hide();
	     $("li").slideDown('slow');	     


	     // --- marks a span element if the users hovers it by changing the css
	     $("span").hover(function()
			     {
				 $(this).css("background-color", "silver");
				 $(this).css("cursor", "pointer");
			     },
			     function(){
				 $(this).css("background-color", "white");
				 $(this).css("cursor", "default");
			     });

	     // --- adds a click handler som the user is able to choose a specifi psi/topic
	     $("span").click(function(){ getFragment($(this).text()); });
	 }

	 // --- the ajax reauest
	 $.ajax({
		 type: "GET",
		 cache: false, // sets a get parameter after the request, so IE doesn' chache the response
		 url: ALL_PSIS_URL,
		 success: successHandler,
		 error: errorHandler
	     });
     }


     // --- gets a specifi fragment belonging to the passed psi
     function getFragment(psi)
     {
	 function successHandler(data)
	 {
	     $("ul").remove();
	     $("#textArea").val(data);
	     $("#allPsisButton").after('<input id="commitButton" type="button" value="commit via post" style="margin:10px;" type="button" onclick="commitJson();"/>');
	 }

	 var url = GET_PREFIX + psi.replace("#", "%23");

	 $.ajax({
		 type: "GET",
		 url: url,
		 cache: false,
		 success: successHandler,
		 error: errorHandler
	     });
     }


     // --- commits the json ragment in the textarea element to the server
     function commitJson()
     {
	 function completeHandler(xhr, textStatus)
	 {
	     alert(xhr.status + ":\n\n" + $("#textArea").val());
	 }


	 $.ajax({
		 type: "POST",
		 url: COMMIT_URL,
		 data: $("#textArea").val(),
		 complete: completeHandler,
		 error: errorHandler
	       });
     }
    //  --> 
    </script>
  </head>

  <body>
    <div id="content" style="margin-top:20px; margin-left:auto; margin-right:auto; border:dashed; width:60%;">
      <input id="allPsisButton" style="margin:10px;" type="button" onclick="getAllPsis()" value="get all psis"/><br/>
      <textarea id="textArea" style="margin-left:10px; margin-bottom:10px;" cols="67" rows="10"></textarea><br/>
      <input id="backButton" style="margin-left:10px; margin-bottom:10px;" type="button" onclick="goBack()" value="clear"/><br/>
    </div>
  </body>
</html>
