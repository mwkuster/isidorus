<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>isidorus with dojo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="main.css"/>

    <!-- includes the prototype and scriptaculous frameworks -->
    <script language="JavaScript" type="text/javascript" src="javascripts/dojo/dojo.js" djConfig="parseOnLoad: true, isDebug: true"></script>

    <!-- own javascript code -->
    <script language="JavaScript" type="text/javascript">
     //dojo.require("dojo.NodeList-fx");
     dojo.require("dojo.html");

     // --- some constants -----------------------------------------------------
     var HOST_PREF = "http://localhost:8000/"; // const instead of var doesn't work with IE
     var GET_PREFIX = HOST_PREF + "json/get/";
     var COMMIT_URL = HOST_PREF + "json/commit/";
     var ALL_PSIS_URL = HOST_PREF + "json/psis/";
     var OWN_URL = HOST_PREF + "isidorus";
     var TIMEOUT = 5000;


     function goBack()
     {
	 window.location = OWN_URL;
     }

     // --- the default error handler for ajax requests
     function errorHandler(err, ioArgs)
     {
	 alert("something went wrong ... " + err);
     }


     function commitJson()
     {
	 function loadHandler(arg)
	 {
	     alert("json:\n" + dojo.byId("textArea").value);
	 }


	 dojo.xhrPost({url: COMMIT_URL,
		       timeout: TIMEOUT,
		       postData: dojo.byId("textArea").value,
		       load: loadHandler,
		       error : errorHandler,
		       headers : {"content-type" : "application/json"}
	             });
     }



     // --- gets a fragment to a specific topic psi and fills the text area with the json response
     // --- additionally the entire psi-tree will be removed
     function getFragment(event)
     {
	 function loadHandler(json)
	 {
	     // --- sets the text area content
	     dojo.byId("textArea").textContent = json;

	     // --- creates a send button
	     var button = dojo.create("input");
	     dojo.attr(button, {"type" : "button", "id" : "commitButton", "value" : "commit via post", "onclick" : "commitJson();"});
	     dojo.place(button, dojo.byId("allPsisButton"), "after");
	 }


	 // --- removes the psis nodes
	 var topicPsi = event.target.innerHTML;
	 var contentDiv = dojo.byId("content");

	 // --- some effects
	 var delta = 0;
	 dojo.forEach(dojo.query("> .divPsi", contentDiv), function(divNode, idx)
		      {
			  setTimeout(function(){dojo.fadeOut({ node: divNode, duration: 2000 }).play();}, delta);
			  delta += 50;
		      });
	 

	 setTimeout(function(){
		 dojo.forEach(dojo.query("> .divPsi", contentDiv), function(divNode, idx)
			      {
				  contentDiv.removeChild(divNode);
			      })},
	     delta);
		     

	 // --- gets the json fragment
	 var url = GET_PREFIX + topicPsi.replace("#", "%23");	 

	 dojo.xhrGet({url: url,
		      timeout: TIMEOUT,
		      preventCache: true,
		      load: loadHandler,
		      error: errorHandler
		     });
     }


     // --- gets all topic psis as a list of lists [[topic-1-psi-1, topic-1-psi-2, ...], [topic-2-psi-1, ...], ...]
     function getAllPsis()
     {
	 // --- the ajax request handler for a successful request
	 function loadHandler(json)
	 {
	     // --- marks a div/span element which is hovered by the user
	     function onmouseoverHandler(event)
	     {
		 var node = event.target;
		 dojo.style(node, {"backgroundColor" : "silver"});
		 dojo.style(node.parentNode, {"border" : "1px solid", "cursor" : "pointer"});
	     }


	     // --- unmarks an element
	     function onmouseleaveHandler(event)
	     {
		 var node = event.target;
		 dojo.style(node, {"backgroundColor" : "white"});
		 dojo.style(node.parentNode, {"border" : "none", "cursor" : "default"});
	     }


	     // --- removes the commit button
	     var cBtn = dojo.byId("commitButton");
	     if(cBtn !== null){
		 cBtn.parentNode.removeChild(dojo.byId("commitButton"));
	     }


	     // --- if there are no psis listed there will be listed all pasis got by the xhr object
	     if(dojo.query(".divPsi").length === 0){
		 dojo.forEach(json, function(topicPsis, idx)
			      {
				  // --- creates a new div node which contains all psis of a topic (-> represents a topic)
				  var topicNode = dojo.create("div");
				  dojo.attr(topicNode, {"class" : "divPsi"});
				  dojo.style(topicNode, "margin", "10px");
				  dojo.place(topicNode, dojo.byId("allPsisButton"), "after");
				  
				  dojo.forEach(topicPsis, function(psi, innerIdx)
					       {
						   // --- creates a span node which contains a psi and will be inserted
						   // --- in the div node created before
						   var psiNode = dojo.create("span");
						   psiNode.innerHTML = psi;
						   dojo.place(psiNode, topicNode, "last");
						   dojo.attr(psiNode, {"onclick" : "getFragment();"});
						   dojo.connect(psiNode, "onmouseover", onmouseoverHandler);
						   dojo.connect(psiNode, "onmouseleave", onmouseleaveHandler);
						   dojo.connect(psiNode, "onclick", getFragment);
						   
						   if(innerIdx !== topicPsis.length - 1 ){
						       dojo.place("<br", psiNode, "after");
						   }
					       });
			      });
	     }
	 }

	 // --- the ajax request
	 dojo.xhrGet({url: ALL_PSIS_URL,
		      handleAs: "json",
		      timeout: TIMEOUT,
		      preventCache: true,
		      load: loadHandler,
		      error: errorHandler
		     });
     }
    </script>
  </head>

  <body>
    <div id="content" style="margin-top:20px; margin-left:auto; margin-right:auto; border:dashed; width:60%;">
      <input id="allPsisButton" style="margin:10px;" type="button" onclick="getAllPsis()" value="get all psis"/><br/>
      <textarea id="textArea" style="margin-left:10px; margin-bottom:10px;" cols="67" rows="10"></textarea><br/>
      <input id="backButton" style="margin-left:10px; margin-bottom:10px;" type="button" onclick="goBack()" value="clear"/><br/>
    </div>
  </body>
</html>
